<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Create Invoice — GST Invoice System</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Import Engry Font for PDF -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    /* Invoice matching styles - single page design */
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --secondary: #64748b;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --light: #f8fafc;
      --dark: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-light: #94a3b8;
      --border-color: #334155;
      --bg-light: #1e293b;
      --card-bg: #0f172a;
      --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      --hover-bg: #1e293b;
      --invoice-bg: #0f172a;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-light);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    /* Simplified Navbar */
    .navbar {
      background: var(--card-bg);
      padding: 15px 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: var(--card-shadow);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 1000;
      min-height: 70px;
    }
    
    .logo {
      display: none; /* Hide the logo */
    }
    
    .back-nav-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 30px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      text-decoration: none;
      font-size: 16px;
    }
    
    .back-nav-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--invoice-bg);
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 30px;
      margin-top: 20px;
      margin-bottom: 30px;
    }
    
    /* Page Title */
    .page-title {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
    }
    
    .page-title h1 {
      color: var(--text-primary);
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .page-title h1 i {
      color: var(--primary);
    }
    
    /* Main content */
    .main-content {
      padding: 0;
    }
    
    /* Card styles */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border-color);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Invoice header */
    .invoice-header-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 20px;
      border: 1px solid var(--border-color);
    }
    
    .shop-info {
      display: flex;
      align-items: center;
      gap: 20px;
      flex: 1;
    }
    
    .shop-logo {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 2rem;
      border: 2px solid var(--border-color);
      overflow: hidden;
      background: var(--bg-light);
    }
    
    .shop-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .shop-details h2 {
      margin: 0 0 8px 0;
      font-size: 1.5rem;
      color: var(--text-primary);
      font-family: 'Playfair Display', serif;
      font-weight: 700;
    }
    
    .shop-details p {
      margin: 4px 0;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }
    
    .invoice-meta {
      text-align: right;
      min-width: 300px;
    }
    
    .invoice-label {
      color: var(--text-secondary);
      font-size: 0.875rem;
      margin-bottom: 8px;
    }
    
    .invoice-number {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 1rem;
    }
    
    /* GST Type Selector */
    .gst-type-selector {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .gst-type-btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: 2px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-primary);
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .gst-type-btn:hover {
      border-color: var(--primary);
    }
    
    .gst-type-btn.active {
      border-color: var(--primary);
      background: rgba(79, 70, 229, 0.1);
      color: var(--primary);
    }
    
    /* Form styles */
    .form-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.875rem;
    }
    
    .form-control {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    textarea.form-control {
      min-height: 80px;
      resize: vertical;
    }
    
    /* Customer details sections */
    .customer-section {
      background: var(--bg-light);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-title i {
      color: var(--primary);
    }
    
    /* Table styles - FIXED: Remove GST column, show only amount without GST */
    .table-container {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 1rem;
      background: var(--card-bg);
      max-height: 400px;
      overflow-y: auto;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }
    
    .table thead {
      background: var(--bg-light);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .table th {
      padding: 14px 12px;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
      font-size: 0.875rem;
      white-space: nowrap;
    }
    
    .table td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }
    
    .table tbody tr:hover {
      background: var(--hover-bg);
    }
    
    .table input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }
    
    .table input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
    }
    
    .table input[readonly] {
      background: var(--bg-light);
      color: var(--text-secondary);
      cursor: not-allowed;
    }
    
    /* Inventory warning */
    .inventory-warning {
      background: rgba(245, 158, 11, 0.1);
      border-left: 4px solid var(--warning);
      padding: 10px 15px;
      margin: 10px 0;
      border-radius: 6px;
      font-size: 0.875rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .inventory-warning i {
      color: var(--warning);
    }
    
    .inventory-error {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--danger);
      padding: 10px 15px;
      margin: 10px 0;
      border-radius: 6px;
      font-size: 0.875rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .inventory-error i {
      color: var(--danger);
    }
    
    /* Action buttons */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 1.5rem;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: var(--bg-light);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover {
      background: var(--hover-bg);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background: #0da271;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.75rem;
    }
    
    .btn-icon {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .btn-icon:hover {
      background: var(--hover-bg);
      color: var(--text-primary);
    }
    
    .btn-icon.delete {
      color: var(--danger);
    }
    
    .btn-icon.delete:hover {
      background: rgba(239, 68, 68, 0.1);
    }
    
    /* Summary panel */
    .summary-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      margin-top: 2rem;
    }
    
    .summary-panel {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
    }
    
    .summary-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    
    .summary-row:last-child {
      border-bottom: none;
    }
    
    .summary-row.grand-total {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
      margin-top: 10px;
      padding-top: 15px;
      border-top: 2px solid var(--border-color);
    }
    
    /* GST Type Info */
    .gst-type-info {
      padding: 1rem;
      background: rgba(79, 70, 229, 0.05);
      border-radius: 8px;
      border-left: 4px solid var(--primary);
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }
    
    /* Terms & Conditions box */
    .terms-box {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1.5rem;
      border: 1px solid var(--border-color);
    }
    
    .terms-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .terms-content {
      color: var(--text-secondary);
      font-size: 0.875rem;
      line-height: 1.6;
      white-space: pre-line;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      background: var(--bg-light);
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }
    
    /* Footer */
    .footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin-top: 10px;
      }
      
      .navbar {
        padding: 15px 20px;
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
      }
      
      .main-content {
        padding: 0;
      }
      
      .page-title h1 {
        font-size: 26px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 1rem;
      }
      
      .form-group {
        min-width: 100%;
      }
      
      .invoice-header-card {
        flex-direction: column;
      }
      
      .invoice-meta {
        text-align: left;
        min-width: 100%;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .action-buttons .btn {
        width: 100%;
        justify-content: center;
      }
      
      .gst-type-selector {
        flex-direction: column;
      }
      
      .gst-type-btn {
        width: 100%;
        justify-content: center;
      }
      
      .table-container {
        max-height: 300px;
      }
    }
  </style>
</head>
<body>
  <!-- Simple Navbar with Centered Back Button -->
  <nav class="navbar">
    <a href="dashboard.html" class="back-nav-btn">
      <i class="fas fa-arrow-left"></i>
      Back to Dashboard
    </a>
  </nav>

  <div class="container">
    <div class="main-content">
      <!-- Page Title -->
      <div class="page-title">
        <h1>
          <i class="fas fa-file-invoice-dollar"></i>
          Create New Invoice
        </h1>
      </div>

      <!-- Invoice Header with Shop Details and Logo -->
      <div class="invoice-header-card">
        <div class="shop-info">
          <div class="shop-logo" id="shopLogoContainer">
            <i class="fas fa-store" id="shopLogoIcon"></i>
          </div>
          <div class="shop-details">
            <h2 id="shopNamePreview">Your Business Name</h2>
            <p id="shopDescPreview">Business Description</p>
            <p id="shopAddressPreview">Address Line 1, City, State - PIN</p>
            <p id="shopContactPreview">Contact: +91 9876543210 | GSTIN: 27ABCDE1234F1Z5 | PAN: ABCDE1234F</p>
          </div>
        </div>
        <div class="invoice-meta">
          <div class="invoice-label">GST INVOICE</div>
          <div class="invoice-number" id="invoiceLabel">INV-0001</div>
          <button type="button" id="downloadPDF" class="btn btn-primary">
            <i class="fas fa-download"></i> Download PDF
          </button>
        </div>
      </div>

      <!-- GST Type Selector -->
      <div class="gst-type-selector">
        <button type="button" class="gst-type-btn active" data-gst-type="sgst-cgst">
          <i class="fas fa-check-circle"></i>
          SGST + CGST (Within State)
        </button>
        <button type="button" class="gst-type-btn" data-gst-type="igst">
          <i class="fas fa-check-circle"></i>
          IGST (Interstate)
        </button>
      </div>

      <div class="gst-type-info" id="gstTypeInfo">
        <strong>SGST + CGST Mode:</strong> Use this for sales within the same state. GST will be split equally between State GST (SGST) and Central GST (CGST).
      </div>

      <!-- Invoice Form -->
      <form id="invoiceForm" novalidate>
        <!-- Invoice Details -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-info-circle"></i>
              Invoice Details
            </h3>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="invoiceNumber">Invoice Number *</label>
              <input type="text" id="invoiceNumber" name="invoiceNumber" class="form-control" 
                     value="INV-0001" required>
            </div>
            <div class="form-group">
              <label for="invoiceDate">Date *</label>
              <input type="date" id="invoiceDate" name="invoiceDate" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="invoiceNote">Reference / Notes</label>
              <input type="text" id="invoiceNote" name="invoiceNote" class="form-control" 
                     placeholder="e.g., Order #123, Project XYZ">
            </div>
          </div>
        </div>

        <!-- Customer Details -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-user"></i>
              Customer Details
            </h3>
          </div>
          
          <!-- Customer Basic Info -->
          <div class="customer-section">
            <div class="section-title">
              <i class="fas fa-building"></i>
              To M/s: *
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label for="custName">Business/Customer Name</label>
                <input type="text" id="custName" name="custName" class="form-control" 
                       placeholder="Enter customer/business name" list="customersList" required>
              </div>
            </div>
          </div>
          
          <!-- Contact and GST Information -->
          <div class="customer-section">
            <div class="section-title">
              <i class="fas fa-address-card"></i>
              Contact & GST Information
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="custMobile">Mobile Number *</label>
                <input type="tel" id="custMobile" name="custMobile" class="form-control" 
                       placeholder="Enter mobile number" required>
              </div>
              <div class="form-group">
                <label for="custGST">GSTIN Number</label>
                <input type="text" id="custGST" name="custGST" class="form-control" 
                       placeholder="Customer GSTIN (Optional)">
              </div>
            </div>
          </div>
          
          <!-- Address Details -->
          <div class="customer-section">
            <div class="section-title">
              <i class="fas fa-map-marked-alt"></i>
              Address Details
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label for="custAddress">Complete Address</label>
                <textarea id="custAddress" name="custAddress" class="form-control" 
                          rows="3" placeholder="Full customer address including street, city, state, PIN"></textarea>
              </div>
            </div>
          </div>
          
          <!-- Shipping Details -->
          <div class="customer-section">
            <div class="section-title">
              <i class="fas fa-truck"></i>
              Shipping Details (If Different)
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label for="shippingAddress">Shipping Address</label>
                <textarea id="shippingAddress" name="shippingAddress" class="form-control" 
                          rows="2" placeholder="Shipping address (if different from billing)"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Items Section - FIXED: Removed GST column -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-list"></i>
              Invoice Items
            </h3>
            <div id="inventoryCheckMessage"></div>
          </div>
          
          <div class="table-container">
            <table class="table" id="itemsTable">
              <thead>
                <tr>
                  <th style="width: 40px">No.</th>
                  <th>Name of Product / Service</th>
                  <th style="width: 100px">HSN Code</th>
                  <th style="width: 70px">Quantity</th>
                  <th style="width: 70px">Unit</th>
                  <th style="width: 100px">Rate (₹)</th>
                  <th style="width: 70px">GST %</th>
                  <th style="width: 120px">Amount (₹) - Without GST</th>
                  <th style="width: 40px">Action</th>
                </tr>
              </thead>
              <tbody id="itemsTableBody">
                <!-- Items will be added here dynamically -->
              </tbody>
            </table>
          </div>
          
          <!-- Inventory Warnings Container -->
          <div id="inventoryWarnings"></div>
          
          <div class="action-buttons">
            <button type="button" id="addRowBtn" class="btn btn-secondary">
              <i class="fas fa-plus"></i> Add Item
            </button>
            <button type="button" id="clearAllBtn" class="btn btn-danger">
              <i class="fas fa-trash"></i> Clear All Items
            </button>
          </div>
        </div>

        <!-- Additional Notes -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-paperclip"></i>
              Additional Notes
            </h3>
          </div>
          <textarea id="additionalNotes" class="form-control" rows="4" 
                    placeholder="Add any additional notes here..."></textarea>
        </div>

        <!-- Terms & Conditions -->
        <div class="terms-box">
          <div class="terms-title">
            <i class="fas fa-file-contract"></i>
            Terms & Conditions
          </div>
          <div class="terms-content" id="termsContent">
            <!-- Terms will be loaded from shop profile -->
          </div>
        </div>

        <!-- Summary Grid -->
        <div class="summary-grid">
          <div></div> <!-- Empty column for layout -->
          
          <!-- Invoice Summary -->
          <div class="summary-panel">
            <div class="summary-title">
              <i class="fas fa-calculator"></i>
              Invoice Summary
            </div>
            
            <div class="summary-row">
              <div class="summary-label">Subtotal (Without GST):</div>
              <div class="summary-value" id="subtotal">₹ 0.00</div>
            </div>
            
            <div id="sgstRow" class="summary-row">
              <div class="summary-label">SGST:</div>
              <div class="summary-value" id="totSGST">₹ 0.00</div>
            </div>
            
            <div id="cgstRow" class="summary-row">
              <div class="summary-label">CGST:</div>
              <div class="summary-value" id="totCGST">₹ 0.00</div>
            </div>
            
            <div id="igstRow" class="summary-row" style="display: none;">
              <div class="summary-label">IGST:</div>
              <div class="summary-value" id="totIGST">₹ 0.00</div>
            </div>
            
            <div class="summary-row grand-total">
              <div class="summary-label">Grand Total (With GST):</div>
              <div class="summary-value" id="grandTotal">₹ 0.00</div>
            </div>
            
            <div class="action-buttons" style="margin-top: 25px;">
              <button type="submit" id="saveInvoiceBtn" class="btn btn-success">
                <i class="fas fa-save"></i> Save Invoice
              </button>
              <button type="button" id="clearInvoiceBtn" class="btn btn-secondary">
                <i class="fas fa-redo"></i> Clear Form
              </button>
              <button type="button" id="pinInvoiceBtn" class="btn btn-primary">
                <i class="fas fa-thumbtack"></i> Pin
              </button>
            </div>
          </div>
        </div>
      </form>
      
      <!-- Footer -->
      <div class="footer">
        <p>GST Invoice Management System © 2024 | All data is stored locally in your browser</p>
      </div>
    </div>
  </div>

  <!-- Datalists for autocomplete -->
  <datalist id="itemsList"></datalist>
  <datalist id="customersList"></datalist>

  <!-- JavaScript Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <!-- SIMPLIFIED SCRIPT -->
  <script>
    // Current GST type (default: sgst-cgst)
    let currentGstType = 'sgst-cgst';
    let inventoryData = [];
    let shopProfile = {};
    let nextInvoiceNumber = 1;
    let inventoryWarnings = [];
    
    // Helper function to extract number from invoice string
    function extractNumberFromInvoiceString(invoiceString) {
        // Try multiple patterns to extract number
        const patterns = [
            /INV-(\d+)/i,
            /INV(\d+)/i,
            /(\d+)$/,
            /-(\d+)$/i
        ];
        
        for (const pattern of patterns) {
            const match = invoiceString.match(pattern);
            if (match) {
                const num = parseInt(match[1], 10);
                if (!isNaN(num)) {
                    return num;
                }
            }
        }
        
        // If no pattern matches, try to extract the last number
        const lastPart = invoiceString.split('-').pop();
        const num = parseInt(lastPart, 10);
        return isNaN(num) ? 0 : num;
    }
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        // This page will be protected by the main script.js
        // Just load the page functionality
        
        // Set default date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('invoiceDate').value = today;
        
        // Calculate next invoice number
        calculateNextInvoiceNumber();
        
        // Generate invoice number
        generateInvoiceNumber();
        
        // Load shop profile
        loadShopProfile();
        
        // Load inventory data for autocomplete
        loadInventoryData();
        
        // Load customers for autocomplete
        loadCustomers();
        
        // Initialize 5 rows
        for (let i = 0; i < 5; i++) {
            addItemRow();
        }
        
        // Setup GST Type Selector
        setupGstTypeSelector();
        
        // Setup event listeners
        setupEventListeners();
        
        // Add invoice number change listener
        document.getElementById('invoiceNumber').addEventListener('input', function() {
            // Update the invoice label when user types
            document.getElementById('invoiceLabel').textContent = this.value;
        });
        
        document.getElementById('invoiceNumber').addEventListener('change', function() {
            updateStoredInvoiceNumber(this.value);
        });
    });
    
    // Calculate next invoice number
    function calculateNextInvoiceNumber() {
        try {
            // FIRST: Check if user manually set a next invoice number in settings
            const storedNextNumber = localStorage.getItem('nextInvoiceNumber');
            if (storedNextNumber) {
                const num = parseInt(storedNextNumber, 10);
                if (!isNaN(num) && num > 0) {
                    nextInvoiceNumber = num;
                    console.log('Using manually set invoice number from settings:', nextInvoiceNumber);
                    return;
                }
            }
            
            // SECOND: Calculate from existing invoices if no manual setting
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            let maxNumber = 0;
            
            invoices.forEach(invoice => {
                if (invoice.invoiceNumber) {
                    const num = extractNumberFromInvoiceString(invoice.invoiceNumber);
                    if (num > maxNumber) {
                        maxNumber = num;
                    }
                }
            });
            
            // If no invoices exist, start from 1
            if (maxNumber === 0) {
                nextInvoiceNumber = 1;
            } else {
                nextInvoiceNumber = maxNumber + 1;
            }
            
            console.log('Calculated next invoice number from existing invoices:', nextInvoiceNumber);
            
        } catch(e) {
            console.log('Error calculating next invoice number:', e);
            nextInvoiceNumber = 1;
        }
    }
    
    // Update stored invoice number when an invoice is saved
    function updateStoredInvoiceNumber(invoiceNumber) {
        if (invoiceNumber) {
            console.log('Saving invoice number:', invoiceNumber);
            
            // Extract the number from the invoice number
            const num = extractNumberFromInvoiceString(invoiceNumber);
            
            if (!isNaN(num) && num > 0) {
                // Set next invoice number to be one more than this number
                const nextNumber = num + 1;
                localStorage.setItem('nextInvoiceNumber', nextNumber.toString());
                console.log('Updated nextInvoiceNumber to:', nextNumber);
                
                // Also update the local variable
                nextInvoiceNumber = nextNumber;
            }
        }
    }
    
    // Generate invoice number
    function generateInvoiceNumber() {
        // Check if we have a stored nextInvoiceNumber
        const storedNextNumber = localStorage.getItem('nextInvoiceNumber');
        if (storedNextNumber) {
            const num = parseInt(storedNextNumber, 10);
            if (!isNaN(num)) {
                nextInvoiceNumber = num;
            }
        }
        
        // Format with leading zeros (INV-0001, INV-0010, etc.)
        const formattedNumber = nextInvoiceNumber.toString().padStart(4, '0');
        const invoiceNumber = `INV-${formattedNumber}`;
        
        document.getElementById('invoiceNumber').value = invoiceNumber;
        document.getElementById('invoiceLabel').textContent = invoiceNumber;
        
        console.log('Generated invoice number:', invoiceNumber, 'from nextInvoiceNumber:', nextInvoiceNumber);
    }
    
    // Load shop profile
    function loadShopProfile() {
        try {
            shopProfile = JSON.parse(localStorage.getItem('shopProfile')) || {};
            
            if (shopProfile.name) {
                document.getElementById('shopNamePreview').textContent = shopProfile.name;
            }
            if (shopProfile.description) {
                document.getElementById('shopDescPreview').textContent = shopProfile.description;
            }
            if (shopProfile.address) {
                document.getElementById('shopAddressPreview').textContent = shopProfile.address;
            }
            
            let contactText = '';
            if (shopProfile.phone) contactText += `Contact: ${shopProfile.phone}`;
            if (shopProfile.gstin) contactText += ` | GSTIN: ${shopProfile.gstin}`;
            if (shopProfile.pan) contactText += ` | PAN: ${shopProfile.pan}`;
            if (shopProfile.email) contactText += ` | Email: ${shopProfile.email}`;
            document.getElementById('shopContactPreview').textContent = contactText;
            
            const logoContainer = document.getElementById('shopLogoContainer');
            const logoIcon = document.getElementById('shopLogoIcon');
            if (shopProfile.logo && shopProfile.logo.startsWith('data:image')) {
                logoIcon.style.display = 'none';
                const logoImg = document.createElement('img');
                logoImg.src = shopProfile.logo;
                logoImg.alt = shopProfile.name;
                logoImg.style.width = '100%';
                logoImg.style.height = '100%';
                logoImg.style.objectFit = 'contain';
                logoContainer.appendChild(logoImg);
            }
            
            if (shopProfile.terms) {
                document.getElementById('termsContent').textContent = shopProfile.terms;
            } else {
                document.getElementById('termsContent').textContent = 'No terms & conditions set. Please update your shop profile.';
            }
            
        } catch(e) {
            console.log('Error loading shop profile:', e);
            document.getElementById('shopNamePreview').textContent = 'Your Business Name';
            document.getElementById('shopDescPreview').textContent = 'Business Description';
            document.getElementById('shopAddressPreview').textContent = 'Address Line 1, City, State - PIN';
            document.getElementById('shopContactPreview').textContent = 'Contact: +91 9876543210 | GSTIN: 27ABCDE1234F1Z5 | PAN: ABCDE1234F';
            document.getElementById('termsContent').textContent = 'No terms & conditions set. Please update your shop profile.';
        }
    }
    
    // Load inventory data
    function loadInventoryData() {
        try {
            inventoryData = JSON.parse(localStorage.getItem('inventory')) || [];
            const itemsList = document.getElementById('itemsList');
            itemsList.innerHTML = '';
            
            inventoryData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.setAttribute('data-hsn', item.hsn || '');
                option.setAttribute('data-unit', item.unit || 'PCS');
                option.setAttribute('data-rate', item.price || 0);
                option.setAttribute('data-gst', item.gstRate || 18);
                option.setAttribute('data-stock', item.stock || 0);
                itemsList.appendChild(option);
            });
            
        } catch(e) {
            console.log('Error loading inventory:', e);
            inventoryData = [];
        }
    }
    
    // Load customers for autocomplete
    function loadCustomers() {
        try {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const customersList = document.getElementById('customersList');
            const seen = new Set();
            customersList.innerHTML = '';
            
            const customersMap = new Map();
            
            invoices.forEach(invoice => {
                if (invoice.customer && invoice.customer.name && !seen.has(invoice.customer.name)) {
                    seen.add(invoice.customer.name);
                    customersMap.set(invoice.customer.name, invoice.customer);
                    
                    const option = document.createElement('option');
                    option.value = invoice.customer.name;
                    customersList.appendChild(option);
                }
            });
            
            document.getElementById('custName').addEventListener('change', function() {
                const selectedCustomer = customersMap.get(this.value);
                if (selectedCustomer) {
                    document.getElementById('custMobile').value = selectedCustomer.mobile || '';
                    document.getElementById('custGST').value = selectedCustomer.gstin || '';
                    document.getElementById('custAddress').value = selectedCustomer.address || '';
                    document.getElementById('shippingAddress').value = selectedCustomer.shippingAddress || '';
                }
            });
            
        } catch(e) {
            console.log('Error loading customers:', e);
        }
    }
    
    // Setup GST Type Selector
    function setupGstTypeSelector() {
        const gstButtons = document.querySelectorAll('.gst-type-btn');
        const gstInfo = document.getElementById('gstTypeInfo');
        
        gstButtons.forEach(button => {
            button.addEventListener('click', function() {
                gstButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                currentGstType = this.dataset.gstType;
                
                if (currentGstType === 'sgst-cgst') {
                    gstInfo.innerHTML = `<strong>SGST + CGST Mode:</strong> Use this for sales within the same state. GST will be split equally between State GST (SGST) and Central GST (CGST).`;
                    document.getElementById('sgstRow').style.display = 'flex';
                    document.getElementById('cgstRow').style.display = 'flex';
                    document.getElementById('igstRow').style.display = 'none';
                } else {
                    gstInfo.innerHTML = `<strong>IGST Mode:</strong> Use this for interstate sales. Integrated GST (IGST) will be applied instead of SGST + CGST.`;
                    document.getElementById('sgstRow').style.display = 'none';
                    document.getElementById('cgstRow').style.display = 'none';
                    document.getElementById('igstRow').style.display = 'flex';
                }
                
                calculateAllTotals();
            });
        });
    }
    
    // Setup event listeners
    function setupEventListeners() {
        // Add row button
        document.getElementById('addRowBtn').addEventListener('click', function() {
            addItemRow();
        });
        
        // Clear all items button
        document.getElementById('clearAllBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all items?')) {
                const tbody = document.getElementById('itemsTableBody');
                tbody.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    addItemRow();
                }
                calculateAllTotals();
                clearInventoryWarnings();
            }
        });
        
        // Clear form button
        document.getElementById('clearInvoiceBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear the entire form? All entered data will be lost.')) {
                resetFormWithNewInvoiceNumber();
            }
        });
        
        // Pin invoice button
        document.getElementById('pinInvoiceBtn').addEventListener('click', function() {
            alert('Invoice pinned! You can view it in the Pinned Bills section.');
        });
        
        // Download PDF button - Single page PDF
        document.getElementById('downloadPDF').addEventListener('click', generatePDF);
        
        // Form submission
        document.getElementById('invoiceForm').addEventListener('submit', saveInvoice);
    }
    
    // Reset form with proper invoice number
    function resetFormWithNewInvoiceNumber() {
        // Calculate next invoice number
        calculateNextInvoiceNumber();
        
        // Generate the invoice number
        generateInvoiceNumber();
        
        // Set today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('invoiceDate').value = today;
        
        // Clear other fields
        document.getElementById('invoiceNote').value = '';
        document.getElementById('custName').value = '';
        document.getElementById('custMobile').value = '';
        document.getElementById('custGST').value = '';
        document.getElementById('custAddress').value = '';
        document.getElementById('shippingAddress').value = '';
        document.getElementById('additionalNotes').value = '';
        
        // Reset items table
        const tbody = document.getElementById('itemsTableBody');
        tbody.innerHTML = '';
        
        for (let i = 0; i < 5; i++) {
            addItemRow();
        }
        
        calculateAllTotals();
        clearInventoryWarnings();
    }
    
    // Clear inventory warnings
    function clearInventoryWarnings() {
        const warningsContainer = document.getElementById('inventoryWarnings');
        if (warningsContainer) {
            warningsContainer.innerHTML = '';
        }
        inventoryWarnings = [];
    }
    
    // Add item row - FIXED: Amount column shows without GST
    function addItemRow() {
        const tbody = document.getElementById('itemsTableBody');
        const rowCount = tbody.querySelectorAll('tr').length + 1;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${rowCount}</td>
            <td>
                <input type="text" class="form-control item-name" 
                       placeholder="Product/Service name" list="itemsList">
            </td>
            <td>
                <input type="text" class="form-control item-hsn" 
                       placeholder="HSN Code" readonly>
            </td>
            <td>
                <input type="number" class="form-control item-qty" 
                       placeholder="Qty" min="0" step="0.001" value="1">
            </td>
            <td>
                <input type="text" class="form-control item-unit" 
                       placeholder="Unit" readonly>
            </td>
            <td>
                <input type="number" class="form-control item-rate" 
                       placeholder="Rate" min="0" step="0.01" value="0">
            </td>
            <td>
                <input type="number" class="form-control item-gst" 
                       placeholder="%" min="0" max="100" step="0.01" value="18">
            </td>
            <td>
                <input type="text" class="form-control item-amount" 
                       placeholder="0.00" readonly>
            </td>
            <td>
                <button type="button" class="btn-icon delete" onclick="removeItemRow(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        
        const nameInput = row.querySelector('.item-name');
        const qtyInput = row.querySelector('.item-qty');
        const rateInput = row.querySelector('.item-rate');
        const gstInput = row.querySelector('.item-gst');
        
        nameInput.addEventListener('change', function() {
            autoFillItemDetails(this);
        });
        
        [qtyInput, rateInput, gstInput].forEach(input => {
            input.addEventListener('input', function() {
                calculateRowAmount(this.closest('tr'));
                checkInventoryForRow(this.closest('tr'));
            });
        });
        
        calculateRowAmount(row);
        return row;
    }
    
    // Auto-fill item details from inventory
    function autoFillItemDetails(nameInput) {
        const itemName = nameInput.value;
        if (!itemName) return;
        
        const item = inventoryData.find(i => i.name === itemName);
        if (item) {
            const row = nameInput.closest('tr');
            row.querySelector('.item-hsn').value = item.hsn || '';
            row.querySelector('.item-unit').value = item.unit || 'PCS';
            row.querySelector('.item-rate').value = item.price || 0;
            row.querySelector('.item-gst').value = item.gstRate || 18;
            
            calculateRowAmount(row);
            checkInventoryForRow(row);
        }
    }
    
    // Check inventory for a specific row
    function checkInventoryForRow(row) {
        const itemName = row.querySelector('.item-name').value;
        const quantity = parseFloat(row.querySelector('.item-qty').value) || 0;
        
        if (!itemName || quantity <= 0) return;
        
        const inventoryItem = inventoryData.find(item => item.name === itemName);
        if (inventoryItem) {
            const availableStock = parseFloat(inventoryItem.stock) || 0;
            
            // Remove any existing warning for this row
            const rowIndex = Array.from(row.parentNode.children).indexOf(row);
            inventoryWarnings = inventoryWarnings.filter(w => w.rowIndex !== rowIndex);
            
            if (quantity > availableStock) {
                // Add warning
                inventoryWarnings.push({
                    rowIndex: rowIndex,
                    itemName: itemName,
                    requested: quantity,
                    available: availableStock
                });
            }
            
            updateInventoryWarningsDisplay();
        }
    }
    
    // Update inventory warnings display
    function updateInventoryWarningsDisplay() {
        const warningsContainer = document.getElementById('inventoryWarnings');
        warningsContainer.innerHTML = '';
        
        if (inventoryWarnings.length === 0) return;
        
        inventoryWarnings.forEach(warning => {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'inventory-error';
            warningDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>Insufficient Stock:</strong> ${warning.itemName} - 
                    Requested: ${warning.requested}, Available: ${warning.available}
                </div>
            `;
            warningsContainer.appendChild(warningDiv);
        });
    }
    
    // Remove item row
    function removeItemRow(button) {
        const row = button.closest('tr');
        if (row) {
            const rowIndex = Array.from(row.parentNode.children).indexOf(row);
            // Remove warning for this row
            inventoryWarnings = inventoryWarnings.filter(w => w.rowIndex !== rowIndex);
            
            row.remove();
            updateRowNumbers();
            calculateAllTotals();
            updateInventoryWarningsDisplay();
        }
    }
    
    // Update row numbers
    function updateRowNumbers() {
        const rows = document.querySelectorAll('#itemsTableBody tr');
        rows.forEach((row, index) => {
            row.cells[0].textContent = index + 1;
        });
    }
    
    // Calculate row amount - FIXED: Amount shows without GST
    function calculateRowAmount(row) {
        const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
        const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
        const gst = parseFloat(row.querySelector('.item-gst').value) || 0;
        
        // Amount WITHOUT GST (simple rate addition)
        const amountWithoutGST = qty * rate;
        
        row.querySelector('.item-amount').value = amountWithoutGST.toFixed(2);
        
        calculateAllTotals();
    }
    
    // Calculate all totals
    function calculateAllTotals() {
        let subtotal = 0;
        let sgstTotal = 0;
        let cgstTotal = 0;
        let igstTotal = 0;
        
        const rows = document.querySelectorAll('#itemsTableBody tr');
        rows.forEach(row => {
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
            const gst = parseFloat(row.querySelector('.item-gst').value) || 0;
            
            const rowSubtotal = qty * rate;
            const gstAmount = rowSubtotal * (gst / 100);
            
            subtotal += rowSubtotal;
            
            if (currentGstType === 'sgst-cgst') {
                sgstTotal += gstAmount / 2;
                cgstTotal += gstAmount / 2;
            } else {
                igstTotal += gstAmount;
            }
        });
        
        const grandTotal = subtotal + sgstTotal + cgstTotal + igstTotal;
        
        // Update display
        document.getElementById('subtotal').textContent = `₹ ${subtotal.toFixed(2)}`;
        document.getElementById('totSGST').textContent = `₹ ${sgstTotal.toFixed(2)}`;
        document.getElementById('totCGST').textContent = `₹ ${cgstTotal.toFixed(2)}`;
        document.getElementById('totIGST').textContent = `₹ ${igstTotal.toFixed(2)}`;
        document.getElementById('grandTotal').textContent = `₹ ${grandTotal.toFixed(2)}`;
    }
    
    // Update inventory after saving invoice
    function updateInventoryFromInvoice(invoiceData) {
        try {
            // Load current inventory
            let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
            
            // Track which items were updated
            const updatedItems = [];
            
            // For each item in the invoice
            invoiceData.items.forEach(invoiceItem => {
                // Find the item in inventory
                const inventoryIndex = inventory.findIndex(item => item.name === invoiceItem.name);
                
                if (inventoryIndex !== -1) {
                    // Item exists in inventory
                    const inventoryItem = inventory[inventoryIndex];
                    const currentStock = parseFloat(inventoryItem.stock) || 0;
                    const soldQty = parseFloat(invoiceItem.qty) || 0;
                    
                    // Calculate new stock
                    const newStock = currentStock - soldQty;
                    
                    // Update inventory
                    inventory[inventoryIndex].stock = Math.max(0, newStock).toFixed(3);
                    inventory[inventoryIndex].lastSold = new Date().toISOString();
                    
                    // Track update
                    updatedItems.push({
                        name: invoiceItem.name,
                        oldStock: currentStock,
                        newStock: Math.max(0, newStock),
                        soldQty: soldQty
                    });
                    
                    console.log(`Inventory updated: ${invoiceItem.name} - Sold: ${soldQty}, New Stock: ${newStock}`);
                } else {
                    console.log(`Item ${invoiceItem.name} not found in inventory`);
                }
            });
            
            // Save updated inventory
            localStorage.setItem('inventory', JSON.stringify(inventory));
            
            // Reload inventory data for this page
            loadInventoryData();
            
            return updatedItems;
            
        } catch (error) {
            console.error('Error updating inventory:', error);
            return [];
        }
    }
    
    // Generate PDF - FIXED: Use the actual invoice number entered by user
    function generatePDF() {
        // Get the current invoice number from the form
        const currentInvoiceNumber = document.getElementById('invoiceNumber').value;
        console.log('Generating PDF with invoice number:', currentInvoiceNumber);
        
        const invoiceData = collectInvoiceData();
        
        // Make sure we use the exact invoice number from the form
        invoiceData.invoiceNumber = currentInvoiceNumber;
        
        // Use the invoice number from the form
        const pdfContent = createPDFContent(invoiceData);
        
        // Single page PDF settings
        const options = {
            margin: [5, 5, 5, 5], // Minimal margins for corner-to-corner
            filename: `invoice-${invoiceData.invoiceNumber}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2,
                useCORS: true,
                letterRendering: true,
                width: 794, // A4 width in pixels at 96 DPI
                height: 1123, // A4 height in pixels at 96 DPI
                windowWidth: 794,
                scrollX: 0,
                scrollY: 0
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait' 
            }
        };
        
        html2pdf().set(options).from(pdfContent).save();
    }
    
    // Collect invoice data
    function collectInvoiceData() {
        const items = [];
        const rows = document.querySelectorAll('#itemsTableBody tr');
        rows.forEach(row => {
            const name = row.querySelector('.item-name').value;
            if (name) {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                const gst = parseFloat(row.querySelector('.item-gst').value) || 0;
                const amountWithoutGST = qty * rate;
                const gstAmount = amountWithoutGST * (gst / 100);
                const totalWithGST = amountWithoutGST + gstAmount;
                
                items.push({
                    name: name,
                    hsn: row.querySelector('.item-hsn').value,
                    qty: qty,
                    unit: row.querySelector('.item-unit').value,
                    rate: rate,
                    gst: gst,
                    amountWithoutGST: amountWithoutGST,
                    gstAmount: gstAmount,
                    totalWithGST: totalWithGST
                });
            }
        });
        
        // Get the EXACT invoice number from the form as entered by user
        let invoiceNumber = document.getElementById('invoiceNumber').value;
        
        return {
            invoiceNumber: invoiceNumber,
            date: document.getElementById('invoiceDate').value,
            note: document.getElementById('invoiceNote').value,
            customer: {
                name: document.getElementById('custName').value,
                mobile: document.getElementById('custMobile').value,
                gstin: document.getElementById('custGST').value,
                address: document.getElementById('custAddress').value,
                shippingAddress: document.getElementById('shippingAddress').value
            },
            items: items,
            subtotal: parseFloat(document.getElementById('subtotal').textContent.replace('₹', '').trim()),
            sgst: parseFloat(document.getElementById('totSGST').textContent.replace('₹', '').trim()),
            cgst: parseFloat(document.getElementById('totCGST').textContent.replace('₹', '').trim()),
            igst: parseFloat(document.getElementById('totIGST').textContent.replace('₹', '').trim()),
            grandTotal: parseFloat(document.getElementById('grandTotal').textContent.replace('₹', '').trim()),
            additionalNotes: document.getElementById('additionalNotes').value,
            gstType: currentGstType,
            shopProfile: shopProfile,
            terms: document.getElementById('termsContent').textContent
        };
    }
    
    // Create PDF content - Professional corner-to-corner invoice WITH LOGO and Shop Mobile/Email
    // FIXED: Removed bottom-left authorized signature (kept only right-side authorized signatory)
    function createPDFContent(data) {
        const container = document.createElement('div');
        container.style.width = '794px'; // A4 width in pixels
        container.style.padding = '20px';
        container.style.fontFamily = 'Arial, Helvetica, sans-serif';
        container.style.fontSize = '11px';
        container.style.lineHeight = '1.4';
        container.style.background = 'white';
        container.style.color = '#000000';
        container.style.boxSizing = 'border-box';
        
        // Header with logo and business info
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'flex-start';
        header.style.borderBottom = '3px solid #000';
        header.style.paddingBottom = '15px';
        header.style.marginBottom = '20px';
        header.style.width = '100%';
        
        // Left side - Business info with logo
        const businessInfo = document.createElement('div');
        businessInfo.style.flex = '1';
        businessInfo.style.display = 'flex';
        businessInfo.style.alignItems = 'flex-start';
        businessInfo.style.gap = '15px';
        
        // Logo container
        const logoContainer = document.createElement('div');
        logoContainer.style.width = '80px';
        logoContainer.style.height = '80px';
        logoContainer.style.border = '2px solid #000';
        logoContainer.style.display = 'flex';
        logoContainer.style.alignItems = 'center';
        logoContainer.style.justifyContent = 'center';
        logoContainer.style.overflow = 'hidden';
        logoContainer.style.background = '#fff';
        
        // Add logo if exists
        if (data.shopProfile.logo && data.shopProfile.logo.startsWith('data:image')) {
            const logoImg = document.createElement('img');
            logoImg.src = data.shopProfile.logo;
            logoImg.alt = data.shopProfile.name || 'Business Logo';
            logoImg.style.width = '100%';
            logoImg.style.height = '100%';
            logoImg.style.objectFit = 'contain';
            logoContainer.appendChild(logoImg);
        } else {
            // Default logo icon
            const defaultLogo = document.createElement('div');
            defaultLogo.style.fontSize = '30px';
            defaultLogo.style.color = '#4f46e5';
            defaultLogo.innerHTML = '<i class="fas fa-store"></i>';
            logoContainer.appendChild(defaultLogo);
        }
        
        // Business text info
        const businessText = document.createElement('div');
        businessText.style.flex = '1';
        
        // Business Name - Large and bold
        const businessName = document.createElement('h1');
        businessName.textContent = data.shopProfile.name || 'PANESAR SANITARY STORE';
        businessName.style.margin = '0 0 5px 0';
        businessName.style.fontSize = '24px';
        businessName.style.fontWeight = '900';
        businessName.style.textTransform = 'uppercase';
        businessName.style.letterSpacing = '1px';
        businessName.style.fontFamily = "'Playfair Display', 'Times New Roman', serif";
        
        // GSTIN and PAN
        const taxInfo = document.createElement('div');
        taxInfo.style.fontWeight = 'bold';
        taxInfo.style.marginBottom = '5px';
        taxInfo.style.fontSize = '11px';
        taxInfo.innerHTML = `
            GSTIN: ${data.shopProfile.gstin || '03ABRPS9453M2ZR'} &nbsp;&nbsp;&nbsp;&nbsp; 
            PAN: ${data.shopProfile.pan || 'ABRPS9453M'}
        `;
        
        // Business Description
        const businessDesc = document.createElement('div');
        businessDesc.style.fontWeight = 'bold';
        businessDesc.style.marginBottom = '5px';
        businessDesc.style.fontSize = '12px';
        businessDesc.textContent = data.shopProfile.description || 'DEALS IN : ALL KIND OF SANITARY';
        
        // Address and Contact Info
        const contactInfo = document.createElement('div');
        contactInfo.style.marginBottom = '10px';
        contactInfo.style.fontSize = '11px';
        
        let contactText = data.shopProfile.address || '#4076/4 OPP. I.T.I. GILL ROAD LUDHIANA';
        if (data.shopProfile.phone) {
            contactText += `<br>Mobile: ${data.shopProfile.phone}`;
        }
        if (data.shopProfile.email) {
            contactText += `<br>Email: ${data.shopProfile.email}`;
        }
        contactInfo.innerHTML = contactText;
        
        businessText.appendChild(businessName);
        businessText.appendChild(taxInfo);
        businessText.appendChild(businessDesc);
        businessText.appendChild(contactInfo);
        
        businessInfo.appendChild(logoContainer);
        businessInfo.appendChild(businessText);
        
        // Right side - Invoice title and number
        const invoiceInfo = document.createElement('div');
        invoiceInfo.style.textAlign = 'right';
        invoiceInfo.style.flex = '1';
        
        // Invoice title
        const invoiceTitle = document.createElement('h2');
        invoiceTitle.textContent = 'GST INVOICE';
        invoiceTitle.style.margin = '0 0 15px 0';
        invoiceTitle.style.fontSize = '28px';
        invoiceTitle.style.fontWeight = 'bold';
        invoiceTitle.style.textDecoration = 'underline';
        invoiceTitle.style.fontFamily = "'Playfair Display', 'Times New Roman', serif";
        invoiceTitle.style.color = '#000';
        
        // Invoice number and date - USING THE EXACT INVOICE NUMBER FROM FORM
        const invoiceDetails = document.createElement('div');
        invoiceDetails.style.fontSize = '14px';
        invoiceDetails.style.fontWeight = 'bold';
        invoiceDetails.innerHTML = `
            <div style="margin-bottom: 8px; font-size: 16px;">Invoice No: <span style="font-size: 18px; color: #000;">${data.invoiceNumber}</span></div>
            <div style="font-size: 14px;">Date: ${new Date(data.date).toLocaleDateString('en-IN')}</div>
        `;
        
        invoiceInfo.appendChild(invoiceTitle);
        invoiceInfo.appendChild(invoiceDetails);
        
        header.appendChild(businessInfo);
        header.appendChild(invoiceInfo);
        container.appendChild(header);
        
        // Customer and invoice details table - corner to corner
        const detailsTable = document.createElement('table');
        detailsTable.style.width = '100%';
        detailsTable.style.borderCollapse = 'collapse';
        detailsTable.style.border = '2px solid #000';
        detailsTable.style.marginBottom = '20px';
        detailsTable.style.fontSize = '10px';
        
        // Build customer info with fixed mobile and GSTIN
        let customerInfoHtml = `
            <div style="font-weight: bold; margin-bottom: 8px; font-size: 12px;">To M/s:</div>
            <div style="margin-bottom: 5px; font-weight: bold; font-size: 16px;">${data.customer.name || ''}</div>
        `;
        
        // Always show Mobile and GSTIN (even if empty)
        customerInfoHtml += `
            <div style="margin-bottom: 3px; font-size: 12px;"><strong>Mobile:</strong> ${data.customer.mobile || 'Not Provided'}</div>
            <div style="margin-bottom: 3px; font-size: 12px;"><strong>GSTIN:</strong> ${data.customer.gstin || 'Not Provided'}</div>
        `;
        
        detailsTable.innerHTML = `
            <tr>
                <td style="border: 1px solid #000; padding: 10px; width: 50%; vertical-align: top;">
                    ${customerInfoHtml}
                </td>
                <td style="border: 1px solid #000; padding: 10px; width: 50%; vertical-align: top;">
                    ${data.note ? `<div style="font-weight: bold; margin-bottom: 5px; font-size: 12px;">Reference:</div>
                    <div style="margin-bottom: 15px; font-size: 12px;">${data.note}</div>` : ''}
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 12px;">Shipping Address:</div>
                    <div style="white-space: pre-line; font-size: 12px;">${data.customer.shippingAddress || data.customer.address || ''}</div>
                </td>
            </tr>
        `;
        
        container.appendChild(detailsTable);
        
        // Items table - corner to corner with full width
        const itemsTable = document.createElement('table');
        itemsTable.style.width = '100%';
        itemsTable.style.borderCollapse = 'collapse';
        itemsTable.style.border = '2px solid #000';
        itemsTable.style.marginBottom = '20px';
        itemsTable.style.fontSize = '10px';
        itemsTable.style.tableLayout = 'fixed';
        
        // Table header
        const thead = document.createElement('thead');
        thead.innerHTML = `
            <tr style="background: #f1f5f9;">
                <th style="border: 1px solid #000; padding: 8px; text-align: center; width: 5%; font-weight: bold; font-size: 11px;">No.</th>
                <th style="border: 1px solid #000; padding: 8px; text-align: left; width: 35%; font-weight: bold; font-size: 11px;">Name of Product / Service</th>
                <th style="border: 1px solid #000; padding: 8px; text-align: center; width: 10%; font-weight: bold; font-size: 11px;">HSN Code</th>
                <th style="border: 1px solid #000; padding: 8px; text-align: center; width: 8%; font-weight: bold; font-size: 11px;">Qty</th>
                <th style="border: 1px solid #000; padding: 8px; text-align: center; width: 8%; font-weight: bold; font-size: 11px;">Unit</th>
                <th style="border: 1px solid #000; padding: 8px; text-align: right; width: 12%; font-weight: bold; font-size: 11px;">Rate</th>
                <th style="border: 1px solid #000; padding: 8px; text-align: right; width: 12%; font-weight: bold; font-size: 11px;">Amount</th>
            </tr>
        `;
        itemsTable.appendChild(thead);
        
        // Table body
        const tbody = document.createElement('tbody');
        
        // Add actual items
        data.items.forEach((item, index) => {
            const row = document.createElement('tr');
            row.style.height = '35px';
            row.innerHTML = `
                <td style="border: 1px solid #000; padding: 6px; text-align: center; vertical-align: middle;">${index + 1}</td>
                <td style="border: 1px solid #000; padding: 6px; vertical-align: middle;">${item.name}</td>
                <td style="border: 1px solid #000; padding: 6px; text-align: center; vertical-align: middle;">${item.hsn || ''}</td>
                <td style="border: 1px solid #000; padding: 6px; text-align: center; vertical-align: middle;">${item.qty}</td>
                <td style="border: 1px solid #000; padding: 6px; text-align: center; vertical-align: middle;">${item.unit}</td>
                <td style="border: 1px solid #000; padding: 6px; text-align: right; vertical-align: middle;">₹${item.rate.toFixed(2)}</td>
                <td style="border: 1px solid #000; padding: 6px; text-align: right; vertical-align: middle;">₹${item.amountWithoutGST.toFixed(2)}</td>
            `;
            tbody.appendChild(row);
        });
        
        // Add empty rows for a total of 12 rows
        const emptyRowsNeeded = Math.max(12 - data.items.length, 0);
        for (let i = 0; i < emptyRowsNeeded; i++) {
            const row = document.createElement('tr');
            row.style.height = '35px';
            const rowNum = data.items.length + i + 1;
            row.innerHTML = `
                <td style="border: 1px solid #000; padding: 6px; text-align: center; vertical-align: middle;">${rowNum}</td>
                <td style="border: 1px solid #000; padding: 6px; vertical-align: middle;"></td>
                <td style="border: 1px solid #000; padding: 6px; text-align: center; vertical-align: middle;"></td>
                <td style="border: 1px solid #000; padding: 6px; text-align: center; vertical-align: middle;"></td>
                <td style="border: 1px solid #000; padding: 6px; text-align: center; vertical-align: middle;"></td>
                <td style="border: 1px solid #000; padding: 6px; text-align: right; vertical-align: middle;"></td>
                <td style="border: 1px solid #000; padding: 6px; text-align: right; vertical-align: middle;"></td>
            `;
            tbody.appendChild(row);
        }
        
        itemsTable.appendChild(tbody);
        container.appendChild(itemsTable);
        
        // New layout: Terms & Conditions on left, Totals on right
        const bottomContainer = document.createElement('div');
        bottomContainer.style.display = 'flex';
        bottomContainer.style.gap = '20px';
        bottomContainer.style.marginBottom = '20px';
        
        // Left side - Terms & Conditions (if available)
        if (data.terms && data.terms !== 'No terms & conditions set. Please update your shop profile.') {
            const termsDiv = document.createElement('div');
            termsDiv.style.flex = '1';
            termsDiv.style.padding = '12px';
            termsDiv.style.border = '1px solid #000';
            termsDiv.style.fontSize = '9px';
            termsDiv.style.background = '#f8f9fa';
            termsDiv.style.minHeight = '180px';
            
            const termsTitle = document.createElement('div');
            termsTitle.style.fontWeight = 'bold';
            termsTitle.style.marginBottom = '10px';
            termsTitle.style.fontSize = '11px';
            termsTitle.textContent = 'Terms & Conditions:';
            
            const termsContent = document.createElement('div');
            termsContent.innerHTML = data.terms.replace(/\n/g, '<br>');
            
            termsDiv.appendChild(termsTitle);
            termsDiv.appendChild(termsContent);
            bottomContainer.appendChild(termsDiv);
        }
        
        // Right side - Totals section
        const totalsDiv = document.createElement('div');
        totalsDiv.style.width = '300px';
        totalsDiv.style.fontSize = '12px';
        
        totalsDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 5px 0; border-bottom: 1px solid #ddd;">
                <div style="font-weight: bold;">Subtotal:</div>
                <div style="font-weight: bold;">₹ ${data.subtotal.toFixed(2)}</div>
            </div>
            ${data.gstType === 'sgst-cgst' ? `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 5px 0; border-bottom: 1px solid #ddd;">
                    <div>SGST:</div>
                    <div>₹ ${data.sgst.toFixed(2)}</div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 5px 0; border-bottom: 1px solid #ddd;">
                    <div>CGST:</div>
                    <div>₹ ${data.cgst.toFixed(2)}</div>
                </div>
            ` : `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding: 5px 0; border-bottom: 1px solid #ddd;">
                    <div>IGST:</div>
                    <div>₹ ${data.igst.toFixed(2)}</div>
                </div>
            `}
            <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 10px; border-top: 2px solid #000; font-size: 16px; font-weight: bold;">
                <div>Grand Total:</div>
                <div>₹ ${data.grandTotal.toFixed(2)}</div>
            </div>
        `;
        
        bottomContainer.appendChild(totalsDiv);
        container.appendChild(bottomContainer);
        
        // Signature section - 2-column layout (removed bottom-left authorized signature)
        const signatureDiv = document.createElement('div');
        signatureDiv.style.marginTop = '50px';
        signatureDiv.style.display = 'flex';
        signatureDiv.style.justifyContent = 'space-between';
        signatureDiv.style.alignItems = 'flex-end';
        signatureDiv.style.paddingTop = '25px';
        signatureDiv.style.borderTop = '1px solid #000';
        
        // Left - Customer Signature
        const customerSign = document.createElement('div');
        customerSign.style.flex = '1';
        customerSign.innerHTML = `
            <div style="font-size: 10px; margin-bottom: 8px; font-weight: bold;">E. & O.E.</div>
            <div style="border-top: 1px solid #000; width: 80%; padding-top: 8px; font-size: 11px; font-weight: bold; margin-top: 25px;">
                Customer's Signature
            </div>
        `;
        
        // Right - Authorized Signatory (ONLY this signature remains)
        const authorizedSign = document.createElement('div');
        authorizedSign.style.flex = '1';
        authorizedSign.style.textAlign = 'right';
        authorizedSign.innerHTML = `
            <div style="font-size: 11px; margin-bottom: 8px; font-weight: bold;">For ${data.shopProfile.name || 'Your Business Name'}</div>
            <div style="border-top: 1px solid #000; width: 80%; margin-left: auto; padding-top: 8px; font-size: 11px; font-weight: bold; margin-top: 25px;">
                Authorized Signatory
            </div>
        `;
        
        signatureDiv.appendChild(customerSign);
        signatureDiv.appendChild(authorizedSign);
        container.appendChild(signatureDiv);
        
        // Bottom note - simple and professional
        const bottomNote = document.createElement('div');
        bottomNote.style.marginTop = '10px';
        bottomNote.style.paddingTop = '10px';
        bottomNote.style.borderTop = '1px solid #ccc';
        bottomNote.style.fontSize = '9px';
        bottomNote.style.textAlign = 'center';
        bottomNote.style.color = '#666';
        
        bottomNote.innerHTML = `
            <div>This is a computer generated invoice. No signature required.</div>
        `;
        
        container.appendChild(bottomNote);
        
        return container;
    }
    
    // Save invoice with inventory update
    function saveInvoice(e) {
        e.preventDefault();
        
        if (!document.getElementById('custName').value) {
            alert('Please enter customer name');
            return;
        }
        
        if (!document.getElementById('custMobile').value) {
            alert('Please enter customer mobile number');
            return;
        }
        
        // Check for inventory warnings
        if (inventoryWarnings.length > 0) {
            const warningText = inventoryWarnings.map(w => 
                `${w.itemName}: Requested ${w.requested}, Available ${w.available}`
            ).join('\n');
            
            if (!confirm(`Insufficient stock for some items:\n\n${warningText}\n\nDo you want to proceed anyway?`)) {
                return;
            }
        }
        
        const invoiceData = collectInvoiceData();
        invoiceData.id = 'inv_' + Date.now();
        invoiceData.status = 'pending';
        invoiceData.createdAt = new Date().toISOString();
        
        // Get current user from sessionStorage
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
        invoiceData.createdBy = currentUser?.email || 'anonymous';
        
        try {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            invoices.push(invoiceData);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            // CRITICAL: Update the stored invoice number for next invoice
            updateStoredInvoiceNumber(invoiceData.invoiceNumber);
            
            // IMPORTANT: Update inventory quantities
            const updatedItems = updateInventoryFromInvoice(invoiceData);
            
            // Show success message with inventory update details
            let successMessage = `Invoice saved successfully! Invoice Number: ${invoiceData.invoiceNumber}`;
            
            if (updatedItems.length > 0) {
                const inventoryUpdateText = updatedItems.map(item => 
                    `${item.name}: Stock reduced from ${item.oldStock} to ${item.newStock}`
                ).join('\n');
                
                successMessage += `\n\nInventory updated:\n${inventoryUpdateText}`;
            }
            
            alert(successMessage);
            
            // Reset form with new invoice number for next invoice
            resetFormWithNewInvoiceNumber();
            
        } catch (error) {
            console.error('Error saving invoice:', error);
            alert('Error saving invoice. Please try again.');
        }
    }
    
    // Make functions available globally
    window.removeItemRow = removeItemRow;
  </script>
</body>
</html>
// Add this to your dashboard.js or script.js
async function initializeApp() {
    // Check if user is logged in
    const currentUser = sessionStorage.getItem('currentUser');
    
    if (!currentUser) {
        // Check for GitHub config and try to auto-login
        await tryAutoLoginFromGitHub();
        return;
    }
    
    // Load GitHub data if configured
    await checkAndLoadGitHubData();
}

async function tryAutoLoginFromGitHub() {
    try {
        const savedConfig = JSON.parse(localStorage.getItem('githubConfig') || '{}');
        
        if (savedConfig.username && savedConfig.repo && savedConfig.token) {
            githubStorage.username = savedConfig.username;
            githubStorage.repo = savedConfig.repo;
            githubStorage.token = savedConfig.token;
            
            // Try to load any user data
            const allData = await githubStorage.loadAnyUserData();
            
            if (allData && allData.users && allData.users.length > 0) {
                // Auto-login with first user (you might want to add a login selection)
                const firstUser = allData.users[0];
                sessionStorage.setItem('currentUser', JSON.stringify(firstUser));
                
                // Save data locally
                if (allData.invoices) localStorage.setItem('invoices', JSON.stringify(allData.invoices));
                if (allData.inventory) localStorage.setItem('inventory', JSON.stringify(allData.inventory));
                if (allData.shopProfile) localStorage.setItem('shopProfile', JSON.stringify(allData.shopProfile));
                
                showAlert('Auto-logged in from cloud!', 'info');
                window.location.href = 'dashboard.html';
                return true;
            }
        }
        
        // No auto-login possible, redirect to login
        window.location.href = 'login.html';
        return false;
    } catch (error) {
        console.error('Auto-login error:', error);
        window.location.href = 'login.html';
        return false;
    }
}

async function checkAndLoadGitHubData() {
    try {
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
        const savedConfig = JSON.parse(localStorage.getItem('githubConfig') || '{}');
        
        if (currentUser.email && savedConfig.username && savedConfig.repo && savedConfig.token) {
            githubStorage.username = savedConfig.username;
            githubStorage.repo = savedConfig.repo;
            githubStorage.token = savedConfig.token;
            
            // Check for newer data on GitHub
            const githubData = await githubStorage.loadUserData(currentUser.email);
            
            if (githubData) {
                // Compare timestamps or implement your sync logic
                console.log('GitHub data available:', githubData);
            }
        }
    } catch (error) {
        console.log('GitHub data check error:', error);
    }
}

// Call this on page load
document.addEventListener('DOMContentLoaded', initializeApp);
