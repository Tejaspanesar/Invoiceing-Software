<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Profile - GST Invoice System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Dark Mode Theme */
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --light: #f8fafc;
            --dark: #1e293b;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
            --border-color: #e2e8f0;
            --bg-light: #f1f5f9;
            --card-bg: #ffffff;
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --hover-bg: #f8fafc;
            --invoice-bg: #ffffff;
        }

        .dark-mode {
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-light: #94a3b8;
            --border-color: #334155;
            --bg-light: #1e293b;
            --card-bg: #0f172a;
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --hover-bg: #1e293b;
            --invoice-bg: #0f172a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        /* Navigation */
        .navbar {
            background: var(--card-bg);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--card-shadow);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .nav-brand i {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-btn {
            padding: 8px 20px;
            background: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            background: var(--invoice-bg);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            margin-top: 20px;
            margin-bottom: 30px;
        }

        /* Page Header */
        .page-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .page-header h1 {
            color: var(--text-primary);
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 0;
        }

        .page-header h1 i {
            color: var(--primary);
        }

        .subtitle {
            color: var(--text-secondary);
            margin-top: 10px;
            font-size: 1.1rem;
        }

        /* Cloud Status Badge */
        .cloud-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 15px;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
        }

        .cloud-status.connected {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
            color: var(--success);
        }

        .cloud-status.disconnected {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger);
            color: var(--danger);
        }

        /* User Info */
        .user-info {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .user-info i {
            color: var(--primary);
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .card-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--hover-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title i {
            color: var(--primary);
        }

        .card-body {
            padding: 2rem;
        }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-control::placeholder {
            color: var(--text-secondary);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Logo Upload Section */
        .logo-upload-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--hover-bg);
            border-radius: 8px;
            border: 2px dashed var(--border-color);
            text-align: center;
        }

        .logo-preview-container {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        #logoPreview {
            max-width: 200px;
            max-height: 120px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            display: none;
        }

        .logo-placeholder {
            width: 200px;
            height: 120px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 2px dashed var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .logo-placeholder i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
        }

        .btn-gh {
            background: #333;
            color: white;
        }

        .btn-gh:hover {
            background: #444;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        /* Back to Dashboard Button */
        .back-to-dashboard {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        .back-to-dashboard .btn {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Invoice Preview */
        .invoice-preview {
            background: var(--hover-bg);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .preview-header {
            border-bottom: 2px solid var(--primary);
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-logo {
            width: 120px;
            height: 60px;
            background: var(--card-bg);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-logo img {
            max-width: 100%;
            max-height: 100%;
        }

        .preview-logo i {
            font-size: 2rem;
            color: var(--primary);
        }

        .preview-content h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .preview-content p {
            color: var(--text-secondary);
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            border-left: 4px solid var(--primary);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success {
            border-left-color: var(--success);
        }

        .toast-error {
            border-left-color: var(--danger);
        }

        .toast-warning {
            border-left-color: var(--warning);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 99999;
        }

        .loading-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Data Source Info */
        .data-source {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .data-source i {
            font-size: 0.8rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin-top: 10px;
            }

            .page-header h1 {
                font-size: 24px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .back-to-dashboard {
                width: 90%;
            }

            .back-to-dashboard .btn {
                width: 100%;
            }

            .preview-header {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
        }

        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-left-color: var(--info);
            color: var(--text-primary);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left-color: var(--warning);
            color: var(--text-primary);
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: var(--success);
            color: var(--text-primary);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: var(--danger);
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingTitle">Loading from Cloud</h3>
            <p id="loadingMessage">Fetching your data from GitHub...</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toastMessage">Message</span>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <a href="dashboard.html" class="nav-brand">
            <i class="fas fa-file-invoice"></i>
            <span>GST Invoice System</span>
        </a>
        <div class="nav-links">
            <span class="user-info" id="userEmailDisplay">
                <i class="fas fa-user"></i>
                <span>Loading...</span>
            </span>
            <a href="settings.html" class="nav-btn">
                <i class="fas fa-cloud"></i>
                Cloud Settings
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <div class="page-header">
            <h1>
                <i class="fas fa-store"></i>
                Shop Profile
                <span class="cloud-status" id="cloudStatus">
                    <i class="fas fa-cloud"></i>
                    <span>Checking...</span>
                </span>
            </h1>
            <p class="subtitle">Manage your business information and logo</p>
        </div>

        <!-- Auto-load Alert -->
        <div class="alert alert-info" id="autoLoadAlert" style="display: none;">
            <i class="fas fa-sync-alt"></i>
            <div>
                <strong>Auto-loading from Cloud</strong>
                <p style="margin-top: 5px; font-size: 0.9rem;">
                    Your data is being loaded from GitHub cloud storage based on your login email.
                </p>
            </div>
        </div>

        <!-- Data Source Info -->
        <div id="dataSourceInfo" style="margin-bottom: 20px; display: none;">
            <span class="data-source">
                <i class="fas fa-database"></i>
                <span>Data loaded from: <strong id="dataSource">Local Storage</strong></span>
            </span>
        </div>

        <!-- Shop Profile Form -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-building"></i>
                    Business Information
                </h2>
                <div id="formStatus" style="font-size: 0.9rem; color: var(--text-secondary);">
                    <i class="fas fa-edit"></i>
                    <span>Ready to edit</span>
                </div>
            </div>
            <div class="card-body">
                <form id="shopProfileForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Shop/Business Name</label>
                            <input type="text" class="form-control" id="shopName" 
                                   placeholder="Enter your business name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Business Category</label>
                            <input type="text" class="form-control" id="businessCategory" 
                                   placeholder="e.g., Retail, Wholesale, Services">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Business Description</label>
                        <textarea class="form-control" id="shopDescription" 
                                  rows="3" placeholder="Describe your business..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="shopPhone" 
                                   placeholder="+91 9876543210">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="shopEmail" 
                                   placeholder="contact@business.com">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">GSTIN Number</label>
                            <input type="text" class="form-control" id="shopGSTIN" 
                                   placeholder="27ABCDE1234F1Z5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">PAN Number</label>
                            <input type="text" class="form-control" id="shopPAN" 
                                   placeholder="ABCDE1234F">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Business Address</label>
                        <textarea class="form-control" id="shopAddress" 
                                  rows="3" placeholder="Complete address including city, state, and PIN"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Bank Details (Optional)</label>
                        <div class="form-row">
                            <div class="form-group">
                                <input type="text" class="form-control" id="bankName" 
                                       placeholder="Bank Name">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" id="accountNumber" 
                                       placeholder="Account Number">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" id="ifscCode" 
                                       placeholder="IFSC Code">
                            </div>
                        </div>
                    </div>

                    <!-- Logo Upload -->
                    <div class="logo-upload-section">
                        <label class="form-label">
                            <i class="fas fa-image"></i> Shop Logo (Optional)
                        </label>
                        
                        <div style="position: relative;">
                            <input type="file" class="form-control" id="logoUpload" 
                                   accept="image/*" style="opacity: 0; position: absolute; width: 100%; height: 100%; cursor: pointer;">
                            <div style="padding: 12px; background: var(--card-bg); border: 2px dashed var(--border-color); border-radius: 8px; text-align: center;">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px; display: block;"></i>
                                <span>Click to upload logo</span>
                                <br>
                                <small style="color: var(--text-secondary);">Supports: JPG, PNG, SVG (Max: 2MB)</small>
                            </div>
                        </div>
                        
                        <div class="logo-preview-container">
                            <div class="logo-placeholder" id="logoPlaceholder">
                                <i class="fas fa-store"></i>
                                <span>No logo uploaded</span>
                            </div>
                            <img id="logoPreview" alt="Shop Logo Preview">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Terms & Conditions</label>
                        <textarea class="form-control" id="shopTerms" rows="5" 
                                  placeholder="Enter your business terms and conditions..."></textarea>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary" id="saveLocalBtn">
                            <i class="fas fa-save"></i> Save Locally
                        </button>
                        <button type="button" class="btn btn-gh" onclick="saveToCloud()" id="saveCloudBtn">
                            <i class="fas fa-cloud-upload-alt"></i> Save to Cloud
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preview Card -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-eye"></i>
                    Preview
                </h2>
            </div>
            <div class="card-body">
                <div class="invoice-preview">
                    <div class="preview-header">
                        <div class="preview-content">
                            <h2 id="previewShopName">Your Business Name</h2>
                            <p id="previewShopDesc">Business Description</p>
                            <p id="previewShopAddress">Address Line 1, City, State - PIN</p>
                            <p id="previewShopContact">
                                <span id="previewPhone">Phone: +91 9876543210</span> | 
                                <span id="previewEmail">Email: contact@business.com</span>
                            </p>
                            <p>
                                <span id="previewGSTIN">GSTIN: Not provided</span> | 
                                <span id="previewPAN">PAN: Not provided</span>
                            </p>
                        </div>
                        <div class="preview-logo" id="previewLogo">
                            <i class="fas fa-store"></i>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 10px;">
                            <i class="fas fa-university"></i> Bank Details
                        </h4>
                        <p id="previewBankDetails" style="color: var(--text-secondary);">Not provided</p>
                    </div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <h4 style="color: var(--text-primary); margin-bottom: 10px;">
                            <i class="fas fa-file-contract"></i> Terms & Conditions
                        </h4>
                        <p id="previewTerms" style="color: var(--text-secondary); font-style: italic;">
                            No terms & conditions set
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Back to Dashboard -->
    <div class="back-to-dashboard">
        <a href="dashboard.html" class="btn">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </a>
    </div>

    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await initShopPage();
        });

        // GitHub Storage Class
        class GitHubStorage {
            constructor() {
                this.username = '';
                this.repo = '';
                this.branch = 'main';
                this.token = '';
                this.dataPath = 'user-data/';
                this.isConfigured = false;
            }
            
            // Load config from localStorage (from settings page)
            loadConfig() {
                try {
                    const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
                    if (config.username && config.repo && config.token) {
                        this.username = config.username;
                        this.repo = config.repo;
                        this.token = config.token;
                        this.isConfigured = true;
                        return true;
                    }
                } catch (e) {
                    console.error('Error loading GitHub config:', e);
                }
                this.isConfigured = false;
                return false;
            }
            
            // Test connection
            async testConnection() {
                if (!this.loadConfig()) {
                    return { success: false, message: 'Not configured' };
                }
                
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/${this.username}/${this.repo}`,
                        {
                            headers: {
                                'Authorization': `token ${this.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (response.ok) {
                        const repoInfo = await response.json();
                        return { 
                            success: true, 
                            message: `Connected to ${repoInfo.full_name}`,
                            data: repoInfo
                        };
                    } else {
                        const error = await response.json();
                        return { 
                            success: false, 
                            message: `Error: ${error.message}`,
                            status: response.status
                        };
                    }
                } catch (error) {
                    return { success: false, message: 'Network error: ' + error.message };
                }
            }
            
            // Load user data from GitHub using email
            async loadUserData(userEmail) {
                if (!this.loadConfig()) {
                    console.log('GitHub not configured');
                    return null;
                }
                
                // Convert email to safe filename
                const safeEmail = userEmail.toLowerCase().replace(/[@.]/g, '-');
                const fileName = `${safeEmail}.json`;
                const filePath = `${this.dataPath}${fileName}`;
                
                console.log('Loading cloud data for:', {
                    email: userEmail,
                    filename: fileName,
                    path: filePath,
                    repo: `${this.username}/${this.repo}`
                });
                
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/${this.username}/${this.repo}/contents/${filePath}`,
                        {
                            headers: {
                                'Authorization': `token ${this.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (response.status === 404) {
                        console.log('No cloud data found for user');
                        return null;
                    }
                    
                    if (!response.ok) {
                        console.error('Cloud load failed:', response.status);
                        return null;
                    }
                    
                    const fileData = await response.json();
                    const decodedContent = decodeURIComponent(escape(atob(fileData.content)));
                    const parsedData = JSON.parse(decodedContent);
                    
                    console.log('Cloud data loaded successfully');
                    return parsedData;
                    
                } catch (error) {
                    console.error('Cloud load error:', error);
                    return null;
                }
            }
            
            // Save data to GitHub
            async saveUserData(userEmail, data) {
                if (!this.loadConfig()) {
                    return { success: false, message: 'Not configured' };
                }
                
                const safeEmail = userEmail.toLowerCase().replace(/[@.]/g, '-');
                const fileName = `${safeEmail}.json`;
                const filePath = `${this.dataPath}${fileName}`;
                
                // Prepare data
                const content = JSON.stringify(data, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                try {
                    // Check if file exists to get SHA
                    let sha = null;
                    try {
                        const existingFile = await fetch(
                            `https://api.github.com/repos/${this.username}/${this.repo}/contents/${filePath}`,
                            {
                                headers: {
                                    'Authorization': `token ${this.token}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            }
                        );
                        
                        if (existingFile.ok) {
                            const fileData = await existingFile.json();
                            sha = fileData.sha;
                            console.log('Found existing file with SHA:', sha);
                        }
                    } catch (error) {
                        console.log('File does not exist, will create new');
                    }
                    
                    // Create data directory if needed
                    await this.createDataDirectory();
                    
                    // Create or update the file
                    const requestBody = {
                        message: `GST Invoice System: ${userEmail} - ${new Date().toISOString()}`,
                        content: encodedContent,
                        branch: this.branch
                    };
                    
                    if (sha) {
                        requestBody.sha = sha;
                    }
                    
                    const response = await fetch(
                        `https://api.github.com/repos/${this.username}/${this.repo}/contents/${filePath}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${this.token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        }
                    );
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        console.log('Cloud save successful');
                        return { success: true, message: 'Saved to cloud successfully!' };
                    } else {
                        console.error('Cloud save failed:', result);
                        return { success: false, message: result.message || 'Failed to save to cloud' };
                    }
                    
                } catch (error) {
                    console.error('Cloud save error:', error);
                    return { success: false, message: 'Network error: ' + error.message };
                }
            }
            
            // Create data directory
            async createDataDirectory() {
                try {
                    const checkResponse = await fetch(
                        `https://api.github.com/repos/${this.username}/${this.repo}/contents/${this.dataPath}`,
                        {
                            headers: {
                                'Authorization': `token ${this.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (checkResponse.status === 404) {
                        const readmeContent = '# User Data\n\nThis directory contains user data for GST Invoice System.';
                        const encodedContent = btoa(unescape(encodeURIComponent(readmeContent)));
                        
                        await fetch(
                            `https://api.github.com/repos/${this.username}/${this.repo}/contents/${this.dataPath}README.md`,
                            {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `token ${this.token}`,
                                    'Accept': 'application/vnd.github.v3+json',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    message: 'Create user data directory',
                                    content: encodedContent,
                                    branch: this.branch
                                })
                            }
                        );
                        console.log('Created data directory');
                    }
                } catch (error) {
                    console.log('Directory check/create failed:', error.message);
                }
            }
        }

        // Global GitHub storage instance
        const githubStorage = new GitHubStorage();

        // Main Application
        async function initShopPage() {
            console.log('Initializing Shop Profile Page...');
            
            // Setup dark mode
            setupDarkMode();
            
            // Check if user is logged in
            const currentUser = getCurrentUser();
            if (!currentUser) {
                showToast('Please login first', 'error');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }
            
            // Display user email
            document.getElementById('userEmailDisplay').innerHTML = 
                `<i class="fas fa-user"></i> <span>${currentUser.email}</span>`;
            
            // Setup form and preview
            setupFormSubmission();
            setupLogoUpload();
            setupPreviewUpdates();
            
            // Check cloud status
            await checkCloudStatus();
            
            // Auto-load data based on login email
            await autoLoadData(currentUser.email);
        }

        function setupDarkMode() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            const themePreference = localStorage.getItem('themePreference');
            
            if (darkMode || themePreference === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (themePreference === 'auto') {
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-mode');
                }
            }
        }

        function getCurrentUser() {
            try {
                const userData = sessionStorage.getItem('currentUser');
                if (!userData) {
                    // Also check localStorage as fallback
                    const users = JSON.parse(localStorage.getItem('gstInvoiceUsers') || '[]');
                    if (users.length > 0) {
                        return users[0];
                    }
                    return null;
                }
                return JSON.parse(userData);
            } catch (e) {
                console.error('Error getting current user:', e);
                return null;
            }
        }

        async function autoLoadData(userEmail) {
            console.log('Auto-loading data for:', userEmail);
            
            // Show loading overlay
            showLoading('Loading Your Data', 'Checking local and cloud storage...');
            
            // First, try to load from local storage
            const localData = loadLocalData();
            
            // Update data source info
            document.getElementById('dataSourceInfo').style.display = 'block';
            document.getElementById('dataSource').textContent = 'Local Storage';
            
            if (localData) {
                console.log('Local data found, populating form');
                populateForm(localData);
                updatePreview(localData);
                showToast('Data loaded from local storage', 'success');
                
                // Hide loading
                hideLoading();
                
                // Then try to check for newer cloud data
                checkForCloudUpdates(userEmail, localData);
                return;
            }
            
            // If no local data, check cloud
            console.log('No local data, checking cloud...');
            
            // Update loading message
            updateLoadingMessage('Checking cloud storage for your data...');
            
            // Check if cloud is configured
            if (!githubStorage.loadConfig()) {
                console.log('Cloud not configured, using empty form');
                hideLoading();
                showToast('No data found. Please fill in your shop profile.', 'info');
                return;
            }
            
            // Test cloud connection
            const cloudTest = await githubStorage.testConnection();
            if (!cloudTest.success) {
                console.log('Cloud connection failed:', cloudTest.message);
                hideLoading();
                showToast('Cloud connection failed. Using empty form.', 'warning');
                return;
            }
            
            // Show cloud loading alert
            document.getElementById('autoLoadAlert').style.display = 'flex';
            
            // Load from cloud
            updateLoadingMessage('Loading your data from GitHub cloud...');
            
            try {
                const cloudData = await githubStorage.loadUserData(userEmail);
                
                if (cloudData && cloudData.shopProfile) {
                    console.log('Cloud data found, loading...');
                    
                    // Update data source info
                    document.getElementById('dataSource').textContent = 'GitHub Cloud';
                    
                    // Populate form with cloud data
                    populateForm(cloudData.shopProfile);
                    updatePreview(cloudData.shopProfile);
                    
                    // Also save to local storage for future use
                    localStorage.setItem('shopProfile', JSON.stringify(cloudData.shopProfile));
                    
                    hideLoading();
                    showToast('Data loaded from cloud storage!', 'success');
                    
                    // Update cloud status
                    updateCloudStatus(true, `Loaded from ${githubStorage.username}/${githubStorage.repo}`);
                    
                    // Update last sync time
                    updateLastSyncTime();
                    
                } else {
                    console.log('No cloud data found');
                    hideLoading();
                    showToast('No shop profile data found. Please fill in your information.', 'info');
                }
                
            } catch (error) {
                console.error('Cloud load error:', error);
                hideLoading();
                showToast('Error loading from cloud: ' + error.message, 'error');
            }
        }

        function loadLocalData() {
            try {
                const savedData = localStorage.getItem('shopProfile');
                return savedData ? JSON.parse(savedData) : null;
            } catch (e) {
                console.error('Error loading local data:', e);
                return null;
            }
        }

        async function checkForCloudUpdates(userEmail, localData) {
            // Only check cloud if configured
            if (!githubStorage.loadConfig()) {
                return;
            }
            
            try {
                const cloudData = await githubStorage.loadUserData(userEmail);
                
                if (cloudData && cloudData.shopProfile) {
                    // Compare timestamps or implement version checking
                    const localTimestamp = localData.lastUpdated || 0;
                    const cloudTimestamp = cloudData.shopProfile.lastUpdated || 0;
                    
                    if (cloudTimestamp > localTimestamp) {
                        // Cloud has newer data
                        showToast('Newer data available in cloud! Click to load.', 'warning', 5000);
                        document.getElementById('saveCloudBtn').innerHTML = 
                            '<i class="fas fa-cloud-download-alt"></i> Load Newer Cloud Data';
                        document.getElementById('saveCloudBtn').onclick = function() {
                            loadNewerCloudData(userEmail, cloudData.shopProfile);
                        };
                    }
                }
            } catch (error) {
                console.log('Cloud update check failed:', error);
            }
        }

        async function loadNewerCloudData(userEmail, cloudData) {
            if (confirm('Newer data found in cloud. Load it now?')) {
                showLoading('Loading Cloud Data', 'Updating from cloud...');
                
                populateForm(cloudData);
                updatePreview(cloudData);
                localStorage.setItem('shopProfile', JSON.stringify(cloudData));
                
                hideLoading();
                showToast('Data updated from cloud!', 'success');
                
                // Reset button
                document.getElementById('saveCloudBtn').innerHTML = 
                    '<i class="fas fa-cloud-upload-alt"></i> Save to Cloud';
                document.getElementById('saveCloudBtn').onclick = function() {
                    saveToCloud();
                };
            }
        }

        function populateForm(data) {
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key);
                if (element && key !== 'logo') {
                    element.value = data[key] || '';
                }
            });
            
            // Load logo if exists
            if (data.logo) {
                const logoPreview = document.getElementById('logoPreview');
                const logoPlaceholder = document.getElementById('logoPlaceholder');
                const previewLogo = document.getElementById('previewLogo');
                
                logoPreview.src = data.logo;
                logoPreview.style.display = 'block';
                logoPlaceholder.style.display = 'none';
                previewLogo.innerHTML = `<img src="${data.logo}" alt="Shop Logo">`;
            }
        }

        function setupFormSubmission() {
            const form = document.getElementById('shopProfileForm');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form data
                const formData = getFormData();
                
                // Save to localStorage
                localStorage.setItem('shopProfile', JSON.stringify(formData));
                
                // Update preview
                updatePreview(formData);
                
                // Show success message
                showToast('Profile saved locally!', 'success');
                
                // Update form status
                document.getElementById('formStatus').innerHTML = 
                    '<i class="fas fa-check-circle" style="color: var(--success);"></i> <span>Saved Locally</span>';
            });
        }

        function getFormData() {
            const data = {};
            
            // Get all form inputs
            const formElements = document.querySelectorAll('#shopProfileForm input:not([type="file"]), #shopProfileForm textarea');
            
            formElements.forEach(element => {
                if (element.id) {
                    data[element.id] = element.value;
                }
            });
            
            // Get logo data
            const logoPreview = document.getElementById('logoPreview');
            if (logoPreview.src && !logoPreview.src.includes('data:,')) {
                data.logo = logoPreview.src;
            }
            
            // Add timestamp
            data.lastUpdated = new Date().toISOString();
            
            return data;
        }

        function setupLogoUpload() {
            const logoUpload = document.getElementById('logoUpload');
            const logoPreview = document.getElementById('logoPreview');
            const logoPlaceholder = document.getElementById('logoPlaceholder');
            const previewLogo = document.getElementById('previewLogo');
            
            logoUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size
                    if (file.size > 2 * 1024 * 1024) {
                        showToast('File size must be less than 2MB', 'error');
                        return;
                    }
                    
                    // Validate file type
                    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/svg+xml'];
                    if (!validTypes.includes(file.type)) {
                        showToast('Please upload a valid image file (JPG, PNG, SVG)', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // Show preview
                        logoPreview.src = e.target.result;
                        logoPreview.style.display = 'block';
                        logoPlaceholder.style.display = 'none';
                        
                        // Update main preview
                        previewLogo.innerHTML = `<img src="${e.target.result}" alt="Shop Logo">`;
                        
                        // Auto-save to local storage
                        const formData = getFormData();
                        formData.logo = e.target.result;
                        localStorage.setItem('shopProfile', JSON.stringify(formData));
                        
                        showToast('Logo uploaded and saved!', 'success');
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
        }

        function setupPreviewUpdates() {
            const formElements = document.querySelectorAll('#shopProfileForm input:not([type="file"]), #shopProfileForm textarea');
            
            formElements.forEach(element => {
                element.addEventListener('input', updatePreviewFromForm);
                element.addEventListener('change', updatePreviewFromForm);
            });
        }

        function updatePreviewFromForm() {
            const formData = getFormData();
            updatePreview(formData);
        }

        function updatePreview(data) {
            // Business Info
            document.getElementById('previewShopName').textContent = data.shopName || 'Your Business Name';
            document.getElementById('previewShopDesc').textContent = data.shopDescription || 'Business Description';
            document.getElementById('previewShopAddress').textContent = data.shopAddress || 'Address Line 1, City, State - PIN';
            document.getElementById('previewPhone').textContent = `Phone: ${data.shopPhone || '+91 9876543210'}`;
            document.getElementById('previewEmail').textContent = `Email: ${data.shopEmail || 'contact@business.com'}`;
            document.getElementById('previewGSTIN').textContent = `GSTIN: ${data.shopGSTIN || 'Not provided'}`;
            document.getElementById('previewPAN').textContent = `PAN: ${data.shopPAN || 'Not provided'}`;
            
            // Bank Details
            if (data.bankName || data.accountNumber || data.ifscCode) {
                const bankDetails = [];
                if (data.bankName) bankDetails.push(`Bank: ${data.bankName}`);
                if (data.accountNumber) bankDetails.push(`Account: ${data.accountNumber}`);
                if (data.ifscCode) bankDetails.push(`IFSC: ${data.ifscCode}`);
                document.getElementById('previewBankDetails').textContent = bankDetails.join(' | ');
            } else {
                document.getElementById('previewBankDetails').textContent = 'Not provided';
            }
            
            // Terms & Conditions
            document.getElementById('previewTerms').textContent = data.shopTerms || 'No terms & conditions set';
        }

        async function checkCloudStatus() {
            const cloudStatus = document.getElementById('cloudStatus');
            
            const isConfigured = githubStorage.loadConfig();
            
            if (isConfigured) {
                const testResult = await githubStorage.testConnection();
                
                if (testResult.success) {
                    cloudStatus.className = 'cloud-status connected';
                    cloudStatus.innerHTML = `<i class="fas fa-cloud"></i> <span>${testResult.data.full_name}</span>`;
                } else {
                    cloudStatus.className = 'cloud-status disconnected';
                    cloudStatus.innerHTML = '<i class="fas fa-cloud-slash"></i> <span>Cloud Error</span>';
                }
            } else {
                cloudStatus.className = 'cloud-status disconnected';
                cloudStatus.innerHTML = '<i class="fas fa-cloud-slash"></i> <span>Not Configured</span>';
            }
        }

        function updateCloudStatus(isConnected, message) {
            const cloudStatus = document.getElementById('cloudStatus');
            
            if (isConnected) {
                cloudStatus.className = 'cloud-status connected';
                cloudStatus.innerHTML = `<i class="fas fa-cloud"></i> <span>${message}</span>`;
            } else {
                cloudStatus.className = 'cloud-status disconnected';
                cloudStatus.innerHTML = '<i class="fas fa-cloud-slash"></i> <span>Disconnected</span>';
            }
        }

        async function saveToCloud() {
            const currentUser = getCurrentUser();
            
            if (!currentUser || !currentUser.email) {
                showToast('Please login first', 'error');
                return;
            }
            
            const formData = getFormData();
            
            if (!formData.shopName || !formData.shopEmail) {
                showToast('Please fill in business name and email first', 'error');
                return;
            }
            
            // Check cloud configuration
            if (!githubStorage.loadConfig()) {
                showToast('Please configure cloud storage in Settings first', 'error');
                setTimeout(() => window.location.href = 'settings.html', 2000);
                return;
            }
            
            if (!confirm('Save current data to cloud storage?')) {
                return;
            }
            
            try {
                const saveBtn = document.getElementById('saveCloudBtn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px;"></div> Saving...';
                saveBtn.disabled = true;
                
                // Prepare data for cloud
                const cloudData = {
                    shopProfile: formData,
                    metadata: {
                        savedAt: new Date().toISOString(),
                        user: currentUser.email,
                        app: 'GST Invoice System'
                    }
                };
                
                const result = await githubStorage.saveUserData(currentUser.email, cloudData);
                
                if (result.success) {
                    showToast('Data saved to cloud successfully!', 'success');
                    
                    // Update last sync time
                    updateLastSyncTime();
                    
                    // Update cloud status
                    updateCloudStatus(true, 'Saved to Cloud');
                    
                } else {
                    showToast('Save failed: ' + result.message, 'error');
                }
                
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                
            } catch (error) {
                showToast('Save error: ' + error.message, 'error');
                const saveBtn = document.getElementById('saveCloudBtn');
                saveBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Save to Cloud';
                saveBtn.disabled = false;
            }
        }

        function updateLastSyncTime() {
            const now = new Date();
            const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
            config.lastSyncTime = now.toLocaleString();
            config.lastSync = now.toISOString();
            localStorage.setItem('githubConfig', JSON.stringify(config));
        }

        function resetForm() {
            if (confirm('Reset form to empty? This will clear all fields.')) {
                document.getElementById('shopProfileForm').reset();
                
                // Clear logo preview
                const logoPreview = document.getElementById('logoPreview');
                const logoPlaceholder = document.getElementById('logoPlaceholder');
                const previewLogo = document.getElementById('previewLogo');
                
                logoPreview.style.display = 'none';
                logoPreview.src = '';
                logoPlaceholder.style.display = 'flex';
                previewLogo.innerHTML = '<i class="fas fa-store"></i>';
                
                // Clear preview
                updatePreview({});
                
                // Remove local storage
                localStorage.removeItem('shopProfile');
                
                showToast('Form reset', 'info');
            }
        }

        // Loading overlay functions
        function showLoading(title, message) {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function updateLoadingMessage(message) {
            document.getElementById('loadingMessage').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Toast notification
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = 'toast';
            
            // Set icon based on type
            const icon = toast.querySelector('i');
            if (type === 'success') {
                toast.classList.add('toast-success');
                icon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                toast.classList.add('toast-error');
                icon.className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                toast.classList.add('toast-warning');
                icon.className = 'fas fa-exclamation-triangle';
            } else {
                icon.className = 'fas fa-info-circle';
            }
            
            toast.style.display = 'flex';
            
            // Auto-hide
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }
    </script>
</body>
</html>
